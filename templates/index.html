<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #121212; color: #e0e0e0; }
        .card { background-color: #1e1e1e; border: 1px solid #333; }
    </style>
</head>
<body class="p-4">
    <header class="mb-6">
        <h1 class="text-2xl font-bold">Dashboard de Vendas</h1>
        <p class="text-gray-400 text-sm">Visão Geral: Diária, Mensal e Anual</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card p-6 rounded-xl">
            <h2 class="text-gray-400 text-xs font-bold uppercase mb-4">Hoje (Real Time)</h2>
            <div class="mb-2">
                <span class="text-sm text-gray-500">Vendas</span>
                <div class="text-2xl font-bold" id="v_diario">R$ 0,00</div>
                <div class="text-xs text-blue-400"><i class="fas fa-box"></i> <span id="q_diario">0</span> itens</div>
            </div>
            <div class="mb-2">
                <span class="text-sm text-gray-500">Gastos</span>
                <div class="text-xl font-bold text-red-500" id="g_diario">R$ 0,00</div>
            </div>
            <hr class="my-3 border-gray-800">
            <div>
                <span class="text-sm text-gray-500">Lucro Diário</span>
                <div class="text-xl font-bold text-emerald-500" id="l_diario">R$ 0,00</div>
            </div>
        </div>

        <div class="card p-6 rounded-xl">
            <h2 class="text-gray-400 text-xs font-bold uppercase mb-4">Mês Atual</h2>
            <div class="mb-2">
                <span class="text-sm text-gray-500">Acumulado Vendas</span>
                <div class="text-2xl font-bold" id="v_mensal">R$ 0,00</div>
                <div class="text-xs text-blue-400"><i class="fas fa-box"></i> <span id="q_mensal">0</span> itens</div>
            </div>
            <div class="mb-2">
                <span class="text-sm text-gray-500">Acumulado Gastos</span>
                <div class="text-xl font-bold text-red-500" id="g_mensal">R$ 0,00</div>
            </div>
            <hr class="my-3 border-gray-800">
            <div>
                <span class="text-sm text-gray-500">Lucro Mensal</span>
                <div class="text-xl font-bold text-emerald-500" id="l_mensal">R$ 0,00</div>
            </div>
        </div>

        <div class="card p-6 rounded-xl">
            <h2 class="text-gray-400 text-xs font-bold uppercase mb-4">Ano Fiscal</h2>
            <div class="mb-2">
                <span class="text-sm text-gray-500">Total Vendas</span>
                <div class="text-2xl font-bold" id="v_anual">R$ 0,00</div>
                <div class="text-xs text-blue-400"><i class="fas fa-box"></i> <span id="q_anual">0</span> itens</div>
            </div>
            <div class="mb-2">
                <span class="text-sm text-gray-500">Total Gastos</span>
                <div class="text-xl font-bold text-red-500" id="g_anual">R$ 0,00</div>
            </div>
            <hr class="my-3 border-gray-800">
            <div>
                <span class="text-sm text-gray-500">Lucro Anual</span>
                <div class="text-xl font-bold text-emerald-500" id="l_anual">R$ 0,00</div>
            </div>
        </div>
    </div>

    <footer class="mt-8 text-center text-xs text-gray-600">
        Sincronizado com Supabase às <span id="timestamp" class="text-emerald-500">--:--:--</span>
    </footer>

    <script>
        async function atualizarDashboard() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                if(data.erro) { console.error(data.erro); return; }

                const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                // Mapeamento Diário
                document.getElementById('v_diario').innerText = fmt(data.diario.vendas);
                document.getElementById('g_diario').innerText = fmt(data.diario.gastos);
                document.getElementById('l_diario').innerText = fmt(data.diario.lucro);
                document.getElementById('q_diario').innerText = data.diario.itens;

                // Mapeamento Mensal
                document.getElementById('v_mensal').innerText = fmt(data.mensal.vendas);
                document.getElementById('g_mensal').innerText = fmt(data.mensal.gastos);
                document.getElementById('l_mensal').innerText = fmt(data.mensal.lucro);
                document.getElementById('q_mensal').innerText = data.mensal.itens;

                // Mapeamento Anual
                document.getElementById('v_anual').innerText = fmt(data.anual.vendas);
                document.getElementById('g_anual').innerText = fmt(data.anual.gastos);
                document.getElementById('l_anual').innerText = fmt(data.anual.lucro);
                document.getElementById('q_anual').innerText = data.anual.itens;

                // CORREÇÃO DO UNDEFINED
                document.getElementById('timestamp').innerText = data.atualizado_em;

            } catch (err) {
                console.error("Falha ao buscar dados", err);
            }
        }

        atualizarDashboard();
        setInterval(atualizarDashboard, 30000); // Atualiza a cada 30 segundos
    </script>
</body>
</html>
